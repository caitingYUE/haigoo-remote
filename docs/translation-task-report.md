# 翻译任务优化报告 (2025-01-07)

## 1. 问题回顾
在对管理后台-定时任务-翻译任务模块的排查中，发现以下关键问题：

### 1.1 性能瓶颈
- **Pre-flight Cleanup (清理假翻译)**: 任务开始前会扫描全量 `jobs` 表来检查是否存在"假翻译"（只有少量中文字符的翻译）。随着数据量增长，这个操作极其耗时，导致 Vercel Function 在 10秒/60秒 限制内无法进入实际翻译阶段，直接超时。
- **分页策略低效**: 原使用 `excludeIds` 方式分页（`WHERE job_id NOT IN (...)`）。随着已处理数据增多，查询性能急速下降。

### 1.2 架构脆弱
- **动态模块加载**: 使用了复杂的 `ensureRealService` 逻辑尝试从多个路径加载翻译服务，容易在不同环境（本地/生产）下失效。

### 1.3 数据质量风险
- **翻译校验过松**: 原校验逻辑仅检查是否包含中文字符。部分纯英文 JD 如果包含一个中文页脚（如 "地点：上海"），会被误判为已翻译，导致正文仍为英文。

## 2. 优化方案与实施 (已完成)

### 2.1 核心链路重构 (`stream-translate-jobs.js`)
- **移除全量扫描**: 移除了 `cleanFakeTranslations` 函数。翻译任务现在专注于"翻译"，不再承担繁重的清洗工作。
- **Keyset Pagination**: 改用基于游标的分页 (`WHERE job_id > :last_seen_id ORDER BY job_id ASC LIMIT 20`)。无论数据量多大，查询性能始终稳定。
- **简化依赖**: 移除了动态路径探测，直接引用 `translation-service.cjs`。

### 2.2 翻译质量校验增强 (`translation-service.cjs`)
- **引入比例检查**: 新增了校验逻辑。
    - **绝对数量**: 至少包含 20 个中文字符。
    - **中文比例**: 如果文本较长(>100字符)，要求中文内容占比至少 10% 或 纯中文数 > 100。
    - 这有效防止了"英文正文+中文脚注"被标记为翻译成功的情况。

### 2.3 稳定性改进
- **超时保护**: 设置了安全执行时间（50秒），在 Vercel 强制杀掉进程前优雅停止，并记录进度。

## 3. 遗留问题与后续规划

虽然核心链路已修复，但仍有以下点需要关注：

### 3.1 数据清洗 (Data Cleaning)
- **现状**: 为了性能，移除了每次运行时的清洗逻辑。
- **风险**: 如果有历史遗留的"假翻译"数据，或者新校验逻辑仍有漏网之鱼，这些数据将长期保留在"已翻译"状态。
- **建议**: 已创建维护脚本 `scripts/clean-fake-translations.js`。
    - **用法**: `node scripts/clean-fake-translations.js`
    - **策略**: 建议在部署后手动运行一次以清理历史数据，后续可配置为每周 Cron 任务（如果平台支持多 Cron）。

### 3.2 错误重试机制
- **现状**: 当前批次失败会记录日志并跳过，依赖下一次 Cron 再次捞起（因为状态未更新）。
- **优化**: 这种机制对于 Cron 来说是合理的（At-least-once），目前无需过度设计。

### 3.3 监控告警
- **建议**: 可以在 `system-settings` 中记录每次 Cron 的执行结果统计，并在管理后台首页展示最近一次任务的状态，便直接发现异常。

## 4. 验证结论
- **流畅度**: 任务不再卡在启动阶段，能立即开始处理批次。
- **性能**: 分页查询速度显著提升。
- **质量**: 新的校验逻辑能拒绝伪翻译，使其保持在"未翻译"状态，等待下一次（或更高质量的AI模型）处理。
