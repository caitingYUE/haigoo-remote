# 部署验证指南

## 本次部署修复内容

### 1. 修复 Cron Job 数据获取 Bug
**文件**：`api/cron/sync-jobs.js`
**修复**：第76行数据获取字段名错误
```javascript
// ❌ 错误（导致无法获取岗位数据）
const jobs = jobsData.data || []

// ✅ 正确
const jobs = jobsData.jobs || []
```

### 2. 添加后台管理翻译按钮
**文件**：`src/components/DataManagementTabs.tsx`
**新增**：
- `handleTriggerTranslation` 方法：手动触发后端翻译任务
- "翻译数据"按钮：在"处理后数据"标签页
- 翻译统计信息显示

## 验证步骤

### 步骤 1：等待部署完成
1. 访问 Vercel Dashboard
2. 查看 Deployments 列表
3. 确认最新的 develop 分支部署完成
4. 状态显示为 "Ready"

### 步骤 2：验证后台管理功能
1. 访问后台管理页面：https://haigoo.vercel.app/admin_team
2. 登录管理账户
3. 进入"职位数据"模块
4. 点击"处理后数据"标签页
5. **验证**：应该看到两个按钮
   - "刷新处理后数据"（原有）
   - "翻译数据"（新增，绿色）

### 步骤 3：触发翻译任务
1. 在"处理后数据"标签页
2. 点击"翻译数据"按钮
3. **预期行为**：
   - 按钮显示"翻译中..."和旋转图标
   - 等待几秒到几十秒（取决于数据量）
   - 显示成功提示：
     ```
     翻译完成
     共处理 X 个岗位，翻译 Y 个，跳过 Z 个，失败 W 个
     ```

### 步骤 4：验证后台数据
1. 刷新"处理后数据"列表
2. **验证点**：
   - "语言"列应该显示"中文"（而不是"英语"）
   - 点击任意岗位的"详情"按钮
   - 在详情中查看是否包含 `translations` 字段
   - 翻译内容应该是中文

### 步骤 5：验证前端页面
1. 访问前端页面：https://haigoo.vercel.app
2. 点击"全部岗位"
3. **验证点**：
   - 岗位标题应该显示中文
   - 公司名称保持英文（不翻译）
   - 岗位描述应该显示中文
   - 地点信息应该显示中文
4. 点击"智能推荐"
5. **验证点**：
   - "Top 3 推荐岗位"显示中文
   - "更多推荐岗位"显示中文

### 步骤 6：验证岗位详情
1. 在前端页面点击任意岗位卡片
2. 打开岗位详情弹窗
3. **验证点**：
   - 标题：中文
   - 公司名称：英文（保持原文）
   - 描述：中文
   - 地点：中文
   - 标签：显示（不翻译，技术标签）
   - "译/原"按钮：点击可切换显示原文和翻译

### 步骤 7：API 测试
打开浏览器控制台或使用 curl：

```bash
# 测试1：获取处理后的岗位数据
curl "https://haigoo.vercel.app/api/data/processed-jobs?page=1&limit=5"
```

**预期响应**：
```json
{
  "jobs": [
    {
      "id": "...",
      "title": "Software Engineer",
      "company": "Google",
      "translations": {
        "title": "软件工程师",
        "description": "我们正在寻找...",
        "location": "远程",
        "company": "Google"
      },
      "isTranslated": true,
      "translatedAt": "2025-11-12T..."
    }
  ],
  "total": 100,
  "page": 1,
  "pageSize": 5,
  "totalPages": 20
}
```

```bash
# 测试2：手动触发翻译任务（如果有授权）
curl -X POST "https://haigoo.vercel.app/api/cron/sync-jobs" \
  -H "Content-Type: application/json"
```

**预期响应**：
```json
{
  "success": true,
  "message": "定时任务完成",
  "stats": {
    "totalJobs": 100,
    "translatedJobs": 85,
    "skippedJobs": 15,
    "failedJobs": 0,
    "duration": "45000ms"
  },
  "timestamp": "2025-11-12T..."
}
```

## 验证清单

### 后台管理
- [ ] 能看到"翻译数据"按钮
- [ ] 点击按钮后显示"翻译中..."状态
- [ ] 翻译完成后显示统计信息
- [ ] 数据列表显示"中文"语言标签
- [ ] 岗位详情包含 `translations` 字段

### 前端页面
- [ ] "全部岗位"显示中文标题
- [ ] "全部岗位"显示中文描述
- [ ] "智能推荐"显示中文内容
- [ ] 公司名称保持英文（不翻译）
- [ ] 岗位详情可以切换"译/原"

### API
- [ ] `/api/data/processed-jobs` 返回包含 `translations` 的数据
- [ ] 数据中 `isTranslated` 为 `true`
- [ ] `/api/cron/sync-jobs` 可以手动触发翻译

### 日志
- [ ] Vercel Functions 日志中能看到翻译相关日志
- [ ] 无错误日志
- [ ] 翻译成功率高（> 95%）

## 常见问题

### Q1: 点击"翻译数据"按钮后显示"没有需要处理的岗位数据"
**原因**：数据库中没有岗位数据，或 Cron Job 无法获取数据

**解决**：
1. 先点击"刷新处理后数据"按钮，拉取RSS数据
2. 等待刷新完成
3. 再点击"翻译数据"按钮

### Q2: 翻译任务显示"翻译失败"
**可能原因**：
1. Google Translate API 请求失败（网络问题）
2. 翻译服务未正确加载
3. 数据格式问题

**解决**：
1. 检查 Vercel Functions 日志：
   - 访问 Vercel Dashboard
   - Functions → `/api/cron/sync-jobs`
   - 查看错误日志
2. 确认环境变量 `ENABLE_AUTO_TRANSLATION=true`
3. 重新部署项目

### Q3: 前端页面仍然显示英文
**可能原因**：
1. 浏览器缓存
2. 数据未重新翻译
3. 页面缓存未更新

**解决**：
1. 强制刷新页面（Cmd/Ctrl + Shift + R）
2. 清除浏览器缓存
3. 后台管理重新点击"翻译数据"
4. 前端页面点击"刷新"（如果有缓存刷新按钮）

### Q4: 部分岗位翻译，部分未翻译
**原因**：翻译任务部分成功

**解决**：
1. 查看翻译统计中的"失败"数量
2. 检查后端日志，找到失败原因
3. 再次点击"翻译数据"按钮（会跳过已翻译的）

### Q5: 后台管理看到翻译，但前端未显示
**原因**：前端组件未正确使用翻译字段

**检查**：
1. 打开浏览器开发者工具
2. Network → 查看 `/api/data/processed-jobs` 响应
3. 确认数据包含 `translations` 字段
4. Console → 查看是否有前端错误
5. 检查前端代码是否正确使用 `job.translations?.xxx || job.xxx`

## 成功标准

### 必须满足
1. ✅ 后台管理可以手动触发翻译
2. ✅ 翻译任务成功执行（成功率 > 95%）
3. ✅ 后台数据显示"中文"语言标签
4. ✅ 前端"全部岗位"显示中文内容
5. ✅ 前端"智能推荐"显示中文内容

### 建议满足
1. ✅ 翻译任务耗时 < 60秒（100个岗位）
2. ✅ 无翻译错误日志
3. ✅ 公司名称保持英文（不翻译）
4. ✅ 技术标签保持原文（不翻译）
5. ✅ 岗位详情可以切换"译/原"

## 下一步

### 如果验证失败
1. 检查 Vercel 部署日志
2. 检查 Functions 运行日志
3. 联系开发人员进行故障排查

### 如果验证成功
1. 合并 develop 分支到 main
2. 部署到生产环境
3. 监控生产环境翻译任务执行情况
4. 设置 Vercel Cron Job 定时任务（每天凌晨2:00）

## 监控建议

### 定期检查
- 每天检查翻译任务执行日志
- 监控翻译成功率
- 查看前端用户反馈

### 性能监控
- 翻译任务执行时间
- API响应时间
- 前端页面加载速度

### 数据质量
- 翻译准确性
- 公司名称是否保持原文
- 技术术语翻译质量

## 相关文档
- [架构修复总结](./ARCHITECTURE_FIX_SUMMARY.md)
- [翻译激活指南](./TRANSLATION_ACTIVATION_GUIDE.md)
- [架构优化计划](./ARCHITECTURE_OPTIMIZATION_PLAN.md)

