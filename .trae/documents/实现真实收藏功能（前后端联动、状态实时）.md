## 目标
- 支持用户在岗位列表/详情中收藏/取消收藏，真实写入后台用户数据库。
- 在个人中心收藏页读取后端数据并展示收藏岗位卡片与状态（有效中/已失效/已下架）。
- 状态随后台职位数据变化而实时更新（请求返回时动态计算；支持刷新/事件驱动）。

## 数据模型
- Redis/Upstash 或 Vercel KV：
  - Key: `haigoo:userfavorites:<userId>`
  - 数据结构：
    - Redis 优先使用 Set（`SADD`/`SREM`/`SMEMBERS`）。
    - KV 使用集合（`kv.sadd`/`kv.srem`/`kv.smembers`）；若集合不可用则存 JSON 数组（读改写）。
  - 备份：同步到内存 Map 作为开发环境回退。

## 后端 API 设计
- 新增 `/api/favorites`（Serverless）：
  - 认证：从 `Authorization: Bearer <token>` 验证用户（`server-utils/auth-helpers.js:31`）。
  - `GET /api/favorites`: 返回收藏 jobId 列表及联动后的详情与状态。
  - `POST /api/favorites`: body `{ jobId }` → 收藏（幂等）。
  - `DELETE /api/favorites`: body `{ jobId }` → 取消收藏（幂等）。
- 状态计算（GET 时）：
  - 读取收藏的 `jobIds`。
  - 批量查询处理后职位数据（调用现有 `/api/data/processed-jobs`，若无按 ids 查询端点则分页聚合或增加批量查询端点）。
  - 对每个 job:
    - `存在且 expiresAt > now` → `有效中`；
    - `存在且 expiresAt <= now` → `已失效`；
    - `不存在` → `已下架`。
  - 返回：`[{ jobId, title, company, ... , status }]`（标题/公司优先用后端数据；缺失时用收藏快照）。
- 环境变量：兼容预发 `pre_haigoo_*`（如 `pre_haigoo_REDIS_URL`、`pre_haigoo_KV_REST_API_URL/TOKEN`）。

## 前端改造
- 列表页 `src/pages/JobsPage.tsx`：
  - 替换 `toggleSaveJob`：改为调用 `/api/favorites`（POST/DELETE），携带 token；失败时回滚。
  - 初始化 `useEffect`：`GET /api/favorites` 拉取收藏集并高亮 Bookmark。
  - 事件刷新：监听 `processed-jobs-updated` 触发 `GET /api/favorites` 以更新状态。
- 详情弹窗 `src/components/JobDetailModal.tsx`：
  - `onSave` 走同一逻辑。
- 个人中心收藏页 `ProfileCenterPage.tsx`：
  - `favoritesWithStatus` 来源于 `GET /api/favorites` 返回的数组，直接渲染卡片与状态；移除旧的 `savedJobs` 写整包逻辑。
  - 定时刷新或进入页面时刷新（例如 60s 轮询或手动刷新按钮）。

## 可靠性与一致性
- 幂等：
  - 后端 POST/DELETE 均幂等，重复收藏/取消返回成功但不重复变更。
- 并发：
  - Redis Set 天生去重；KV JSON 数组读改写时加轻量锁（可选，或采用 `kv.sadd/srem`）。
- 安全：
  - 所有接口必须校验 JWT；返回用户隔离数据。
  - 不暴露敏感信息；状态计算仅基于公开岗位数据。

## 用户体验优化
- 收藏按钮：点击后即时反馈（高亮/取消高亮），失败回滚并提示。
- 收藏页：增加“刷新状态”按钮与时间戳；状态徽标与文案按视觉稿（绿点/灰/红）。

## 实施步骤
1. 新建 `api/favorites.js`，实现 GET/POST/DELETE，封装 Redis/KV 读写与状态计算。
2. 改造列表页与详情弹窗的收藏调用；初始化拉取收藏集。
3. 个人中心收藏页改为调用新接口渲染真实数据与状态；增加刷新机制。
4. 预发环境变量检查：确保 Redis/KV 可用；验证 `/api/favorites` 与 `/api/data/processed-jobs` 的联动。
5. 推送到 `develop`，在预发进行端到端验证（收藏→个人页可见→后台数据变化后状态随刷新更新）。

## 验收与测试
- 用测试账号：收藏/取消多个岗位后刷新个人页，看到卡片与正确状态；过期模拟或下架模拟后状态变更正确。
- 错误处理：未登录收藏跳转登录；后台不可用时提示并不破坏页面渲染。
