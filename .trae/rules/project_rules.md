---
alwaysApply: true
---

# 🔥 核心必读规范 (MUST READ)

以下规范涉及数据安全、核心业务逻辑和系统稳定性，**每次开发前必读**，违反可能导致严重事故。

### 1. 🛡️ 数据完整性与安全 (Data Integrity & Safety)
- **数据完整性守卫 (Integrity Guard)**：涉及核心实体（Jobs/Users）更新的逻辑，**必须**使用 `lib/utils/data-integrity.js` 中的 `mergeWithIntegrity` 进行安全合并，并使用 `validateIntegrity` 进行写入前检查。**严禁**手动逐个字段赋值，以防字段遗漏。
- **全量查询原则 (Full Query)**：在执行 Read-Modify-Write 操作时，**必须**使用 `SELECT *` 查询原始数据，**严禁**为了微小的性能优化而手动列举字段，除非你有 100% 把握该业务逻辑不需要未来扩展字段。
- **禁止静默兜底 (No Silent Failures)**：如果核心服务（如数据库、第三方API）不可用，**必须直接抛出错误**，让系统感知异常。**严禁**返回空数据（如 `null`/`[]`）或 Mock 数据来掩盖问题，这会导致前端误判为“数据被清空”。
- **数据库错误显性化**：数据库连接失败或配置缺失时，必须抛出明确错误。

### 2. 🚫 核心业务逻辑保护 (Core Logic Protection)
- **严禁擅自修改核心流程**：包括但不限于【数据审核状态】（如默认是否通过）、【数据可见性】、【支付/会员权限】等。任何涉及这些字段默认值或处理流程的变更，**必须先明确告知用户并获得确认**。
- **禁止“隐式”业务变更**：严禁在修复 Bug、优化性能或开发其他功能时，顺带修改核心业务逻辑（例如：为了方便测试而将新数据默认设为已审核）。
- **关键状态变更需显式注释**：如果确实经过确认需要修改核心状态逻辑，必须在代码中添加详细注释，说明修改人、日期、原因以及影响范围。

### 3. 💣 严禁 Mock 与 强制兜底
- **严禁使用 Mock 数据**：在任何场景下（包括开发、测试、生产），都**不得**使用 Mock 数据。如果服务不可用，请报错。
- **严禁强制兜底解决 Bug**：必须要从根源上找到问题原因，而不是通过“强制兜底”（如 `try-catch` 后吞掉错误）来临时掩盖问题。

### 4. 🏳️ 白名单规范
- **严禁滥用白名单**：白名单仅用于方便内测。**严禁**为了短暂解决问题、投机取巧而给企业/职位加白名单。禁止选择短视方案。

---

# 🏗️ 后端开发规范

### 代码结构与位置
- **Next.js 结构**：主要在 `/api` 目录下。
- **分层架构**：
    - `/lib/api-handlers`: API 处理逻辑
    - `/lib/cron-handlers`: 定时任务逻辑
    - `/lib/services`: 核心业务服务
    - `/server-utils`: 工具类与数据库操作

### 数据库操作
- **DDL 管理**：表结构定义在 `/server-utils/dal/neon-ddl.sql` 中。
    - **禁止**在代码中直接写建表/删表语句。
    - 修改表结构时，需在 SQL 文件中新增对应的 `ALTER TABLE` 语句，并注释日期和原因。
- **数据访问**：底层操作封装在 `/server-utils/dal/neon-helper.js` 中。服务层只调用 SQL 进行增删改查。

### 代码质量
- **日志打印**：关键环节使用 `console.log` 打印步骤（如 `step1`, `step2`...），便于排查。
- **变量/常量移除检查**：重构代码时，**必须**全局搜索被移除的变量名，确保无残留引用。
- **Lint 检查**：修改核心工具类后，**必须**运行 `npm run lint`。

---

# 🎨 前端开发规范

- **重后端，轻前端**：前端只负责传递参数、展示数据、处理交互。
- **逻辑后置**：联表、筛选、分页等逻辑**必须**在后端通过 SQL 实现。
- **避免过度缓存**：不要在前端拉取全部数据后进行分页/搜索，应由后端提供接口。

---

# 🚀 工作流与发布规范

### 测试与发布
- **自测要求**：每次变更都需要先自测，**自测 2 次以上**无误再发布。
- **清理工作**：发布前清除测试文件和过程文档。

### Git 提交
- **及时推送**：优化/修改完成后，**必须**记得推送到 git 远程仓库。这是一个必须一直记住、不能遗忘的步骤。

### 权限变更
- **数据库权限**：涉及增删改查操作，请贴出 SQL 代码，提示人工前往数据库操作。
- **用户权限**：管理后台/会员等权限修改，请提示人工前往后台操作。
